{% extends 'base.html' %}
{% load static %}

{% block page %}
<section class="grow basis-full mx-4 mt-5 sm:mt-6 md:mx-5 md:mt-8 lg:mx-6 lg:mt-10 2xl:mx-8 2xl:mt-12" x-cloak>
    <form id="create-form" method="post" action="{% url action %}" class="mx-0 md:mx-auto rounded-md lg:rounded-lg p-4 md:p-8 lg:p-12 xl:p-16 w-full md:w-4/5 lg:w-2/3 xl:w-1/2 space-y-4 lg:space-y-6 shadow-md md:shadow-lg lg:shadow-xl bg-slate-100 dark:bg-slate-700 dark:shadow-violet-800"
        {% if model_name == 'Relationship' %}
        x-data="{
            allClasses: {{ all_classes }},
            selectedFromClass: {% if form.from_class.value %}'{{ form.from_class.value }}'{% else %}''{% endif %},
            selectedToClass: {% if form.to_class.value %}'{{ form.to_class.value }}'{% else %}''{% endif %},
            fromClassOptions: {{ all_classes }},
            toClassOptions: {{ all_classes }},
            
            updateToClasses() {
                if (this.selectedFromClass) {
                    const selectedClass = this.allClasses.find(cls => cls.id == this.selectedFromClass)
                    if (selectedClass) {
                        this.toClassOptions = this.allClasses.filter(cls => 
                            cls.module === selectedClass.module
                        )
                    }
                } else {
                    this.toClassOptions = this.allClasses
                }
            },
            
            updateFromClasses() {
                if (this.selectedToClass) {
                    const selectedClass = this.allClasses.find(cls => cls.id == this.selectedToClass)
                    if (selectedClass) {
                        this.fromClassOptions = this.allClasses.filter(cls => 
                            cls.module === selectedClass.module
                        )
                    }
                } else {
                    this.fromClassOptions = this.allClasses
                }
            }
        }"
        x-init="() => {$nextTick(() => {if (selectedFromClass) updateToClasses(); if (selectedToClass) updateFromClasses();})}"
        {% endif %}>
        <h2 class="text-center">New {{ model_name }}</h2>
        {% csrf_token %}
        {% for field in form %}
        <div class="field-wrapper group">
        {% if model_name == "Relationship" %}
            {% if field.name == 'from_class' %}
                <div x-data>
                    <template x-if="false">
                        <!-- This keeps the original select for form submission but hides it -->
                        {{ field.as_field_group }}
                    </template>
                    <label for="id_from_class">From Class</label>
                    <select 
                        id="id_from_class"
                        name="from_class"
                        x-model="selectedFromClass"
                        @change="updateToClasses()"
                        class="form-select w-full"
                        required
                    >
                        <option value="">Select From Class</option>
                        <template x-for="cls in fromClassOptions" x-bind:key="`from-${cls.id}`">
                            <option :value="cls.id" x-text="cls.name"></option>
                        </template>
                    </select>
                </div>
            {% elif field.name == 'to_class' %}
                <div x-data>
                    <template x-if="false">
                        <!-- This keeps the original select for form submission but hides it -->
                        {{ field.as_field_group }}
                    </template>
                    <label for="id_to_class">To Class</label>
                    <select 
                        id="id_to_class"
                        name="to_class"
                        x-model="selectedToClass"
                        @change="updateFromClasses()"
                        class="form-select w-full"
                        required
                    >
                        <option value="">Select To Class</option>
                        <template x-for="cls in toClassOptions" :key="cls.id">
                            <option :value="cls.id" x-text="cls.name"></option>
                        </template>
                    </select>
                </div>
            {% else %}
                {{ field.as_field_group }}
            {% endif %}
        {% else %}
            {{ field.as_field_group }}
        {% endif %}
        </div>
        {% endfor %}
        {% if form.errors %}
        <div>
            <p class="text-red-500 dark:text-red-600 text-sm md:text-base">Please correct the following errors:</p>
            <ul class="errorlist">
                {% for field, error_list in form.errors.items %}
                    {% for error in error_list %}
                    <li>{{ field }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        <div class="pt-3">
            <button type="submit" class="ml-auto btn primary">Submit</button>
        </div>
        {% if model_name == "Relationship" %}
        <script>
            function relationshipForm(allClasses) {
                return {
                    allClasses: allClasses,
                    selectedFromClass: {% if form.from_class.value %}"{{ form.from_class.value }}"{% else %}""{% endif %},
                    selectedToClass: {% if form.to_class.value %}"{{ form.to_class.value }}"{% else %}""{% endif %},
                    fromClassOptions: [],
                    toClassOptions: [],
        
                    init() {
                        // Initialize with all classes if no selection
                        this.fromClassOptions = this.allClasses
                        this.toClassOptions = this.allClasses
                        
                        // If we have initial values (edit mode), update the filtered lists
                        if (this.selectedFromClass) this.updateToClasses()
                        if (this.selectedToClass) this.updateFromClasses()
                    },
        
                    updateToClasses() {
                        if (this.selectedFromClass) {
                            const selectedClass = this.allClasses.find(cls => cls.id == this.selectedFromClass)
                            if (selectedClass) {
                                this.toClassOptions = this.allClasses.filter(cls => 
                                    cls.module === selectedClass.module
                                )
                            }
                        } else {
                            this.toClassOptions = this.allClasses
                        }
                    },
        
                    updateFromClasses() {
                        if (this.selectedToClass) {
                            const selectedClass = this.allClasses.find(cls => cls.id == this.selectedToClass)
                            if (selectedClass) {
                                this.fromClassOptions = this.allClasses.filter(cls => 
                                    cls.module === selectedClass.module
                                )
                            }
                        } else {
                            this.fromClassOptions = this.allClasses
                        }
                    }
                }
            }
        </script>
        {% endif %}
    </form>
</section>
<script src="{% static 'js/form.js' %}"></script>
{% endblock %}